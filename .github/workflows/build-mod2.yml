name: Build Nearby Players List Mod - 1.16.5

on:
  workflow_dispatch:

jobs:
  setup-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 6.9
    
    - name: Clean everything
      run: |
        rm -rf src/ build/ .gradle/ gradle/ *.gradle *.properties gradlew* .gitignore
        find . -name "*.java" -delete
        find . -name "*.json" -delete
    
    - name: Create directories
      run: |
        mkdir -p src/main/java/com/nearbyplayers/mixin
        mkdir -p src/main/resources
    
    - name: Write NearbyPlayersMod.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/nearbyplayers/NearbyPlayersMod.java
        package com.nearbyplayers;
        
        import net.fabricmc.api.ClientModInitializer;
        
        public class NearbyPlayersMod implements ClientModInitializer {
            public static final String MOD_ID = "nearbyplayers";
            public static boolean isListVisible = false;
            
            @Override
            public void onInitializeClient() {
            }
        }
        EOF
    
    - name: Write InGameHudMixin.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/nearbyplayers/mixin/InGameHudMixin.java
        package com.nearbyplayers.mixin;
        
        import com.nearbyplayers.NearbyPlayersMod;
        import net.minecraft.client.MinecraftClient;
        import net.minecraft.client.gui.hud.InGameHud;
        import net.minecraft.client.network.ClientPlayerEntity;
        import net.minecraft.client.util.math.MatrixStack;
        import net.minecraft.entity.player.PlayerEntity;
        import org.lwjgl.glfw.GLFW;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.Shadow;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
        
        import java.util.ArrayList;
        import java.util.Comparator;
        import java.util.List;
        
        @Mixin(InGameHud.class)
        public abstract class InGameHudMixin {
            
            @Shadow
            private MinecraftClient client;
            
            @Shadow
            public abstract void drawTextWithShadow(MatrixStack matrices, net.minecraft.client.font.TextRenderer textRenderer, String text, int x, int y, int color);
            
            private boolean wasAltPressed = false;
            
            @Inject(method = "render", at = @At("TAIL"))
            private void onRender(MatrixStack matrices, float tickDelta, CallbackInfo ci) {
                if (this.client == null || this.client.player == null) return;
                
                // فحص زر ALT-Left للتشغيل/الإيقاف
                boolean isAltPressed = GLFW.glfwGetKey(
                    this.client.getWindow().getHandle(), 
                    GLFW.GLFW_KEY_LEFT_ALT
                ) == GLFW.GLFW_PRESS;
                
                if (isAltPressed && !wasAltPressed) {
                    NearbyPlayersMod.isListVisible = !NearbyPlayersMod.isListVisible;
                }
                
                wasAltPressed = isAltPressed;
                
                // عرض القائمة لو مفعّلة
                if (NearbyPlayersMod.isListVisible) {
                    renderNearbyPlayersList(matrices);
                }
            }
            
            private void renderNearbyPlayersList(MatrixStack matrices) {
                if (this.client.world == null || this.client.player == null) return;
                
                ClientPlayerEntity player = this.client.player;
                List<PlayerInfo> nearbyPlayers = new ArrayList<>();
                
                // جمع معلومات اللاعبين القريبين
                for (PlayerEntity p : this.client.world.getPlayers()) {
                    if (p == player) continue; // تجاهل نفسك
                    
                    double distance = player.getPos().distanceTo(p.getPos());
                    nearbyPlayers.add(new PlayerInfo(p.getName().getString(), distance));
                }
                
                // ترتيب حسب المسافة (الأقرب أولاً)
                nearbyPlayers.sort(Comparator.comparingDouble(info -> info.distance));
                
                // رسم الخلفية والقائمة
                int x = 10;
                int y = 10;
                int lineHeight = 12;
                int padding = 4;
                int maxWidth = 200;
                
                // عنوان القائمة
                String title = "§e§lNearby Players";
                this.drawTextWithShadow(matrices, this.client.textRenderer, title, x, y, 0xFFFFFF);
                y += lineHeight + 2;
                
                // خط فاصل
                String separator = "§7" + "─".repeat(25);
                this.drawTextWithShadow(matrices, this.client.textRenderer, separator, x, y, 0x777777);
                y += lineHeight;
                
                // عرض اللاعبين
                if (nearbyPlayers.isEmpty()) {
                    String noPlayers = "§7No players nearby";
                    this.drawTextWithShadow(matrices, this.client.textRenderer, noPlayers, x, y, 0x777777);
                } else {
                    for (PlayerInfo info : nearbyPlayers) {
                        String playerText = String.format("§a%s §7- §c%.0f blocks", 
                            info.name, info.distance);
                        this.drawTextWithShadow(matrices, this.client.textRenderer, playerText, x, y, 0xFFFFFF);
                        y += lineHeight;
                        
                        // حد أقصى 10 لاعبين
                        if (y > 150) break;
                    }
                }
                
                // عدد اللاعبين الإجمالي
                y += 4;
                String total = String.format("§7Total: §e%d player(s)", nearbyPlayers.size());
                this.drawTextWithShadow(matrices, this.client.textRenderer, total, x, y, 0x777777);
            }
            
            private static class PlayerInfo {
                String name;
                double distance;
                
                PlayerInfo(String name, double distance) {
                    this.name = name;
                    this.distance = distance;
                }
            }
        }
        EOF
    
    - name: Write fabric.mod.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/fabric.mod.json
        {
          "schemaVersion": 1,
          "id": "nearbyplayers",
          "version": "1.0.0",
          "name": "Nearby Players List",
          "description": "Shows list of nearby players. Toggle with Left ALT key.",
          "authors": ["SIGMAxox"],
          "license": "MIT",
          "environment": "client",
          "entrypoints": {
            "client": ["com.nearbyplayers.NearbyPlayersMod"]
          },
          "mixins": ["nearbyplayers.mixins.json"],
          "depends": {
            "fabricloader": ">=0.11.0",
            "minecraft": "1.16.5"
          }
        }
        EOF
    
    - name: Write nearbyplayers.mixins.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/nearbyplayers.mixins.json
        {
          "required": true,
          "minVersion": "0.8",
          "package": "com.nearbyplayers.mixin",
          "compatibilityLevel": "JAVA_8",
          "client": ["InGameHudMixin"],
          "injectors": {"defaultRequire": 1}
        }
        EOF
    
    - name: Write build.gradle
      shell: bash
      run: |
        cat << 'EOF' > build.gradle
        plugins {
            id 'fabric-loom' version '0.7-SNAPSHOT'
            id 'maven-publish'
        }
        
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
        
        archivesBaseName = "nearby-players-list"
        version = "1.0.0"
        group = "com.nearbyplayers"
        
        repositories {
            maven { url 'https://maven.fabricmc.net/' }
        }
        
        dependencies {
            minecraft "com.mojang:minecraft:1.16.5"
            mappings "net.fabricmc:yarn:1.16.5+build.10:v2"
            modImplementation "net.fabricmc:fabric-loader:0.11.3"
        }
        
        processResources {
            inputs.property "version", project.version
            filesMatching("fabric.mod.json") {
                expand "version": project.version
            }
        }
        
        tasks.withType(JavaCompile).configureEach {
            it.options.encoding = "UTF-8"
        }
        
        java {
            withSourcesJar()
        }
        
        jar {
            from("LICENSE") {
                rename { "${it}_${project.archivesBaseName}"}
            }
        }
        EOF
    
    - name: Write gradle.properties
      run: echo 'org.gradle.jvmargs=-Xmx2G' > gradle.properties
    
    - name: Write settings.gradle
      shell: bash
      run: |
        cat << 'EOF' > settings.gradle
        pluginManagement {
            repositories {
                maven {
                    name = 'Fabric'
                    url = 'https://maven.fabricmc.net/'
                }
                gradlePluginPortal()
            }
        }
        rootProject.name = 'nearby-players-list'
        EOF
    
    - name: Create Gradle Wrapper
      run: gradle wrapper --gradle-version 6.9
    
    - name: Grant execute permission
      run: chmod +x gradlew
    
    - name: Verify all files
      run: |
        echo "=== Source files ==="
        find src -type f -exec echo {} \; -exec cat {} \;
        echo ""
        echo "=== Config files ==="
        cat build.gradle
        echo ""
        cat settings.gradle
    
    - name: Build mod
      run: ./gradlew clean build --no-daemon --stacktrace
    
    - name: List build output
      run: ls -lah build/libs/
    
    - name: Upload Mod JAR
      uses: actions/upload-artifact@v4
      with:
        name: nearby-players-list-v1.0.0
        path: build/libs/*.jar
