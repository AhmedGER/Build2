# .github/workflows/build-mod.yml
name: Build Bridging Mod (Vanilla Speed)

on:
  workflow_dispatch:

jobs:
  setup-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 6.9
    
    - name: Clean everything
      run: |
        rm -rf src/ build/ .gradle/ gradle/ *.gradle *.properties gradlew* .gitignore
        find . -name "*.java" -delete
        find . -name "*.json" -delete
    
    - name: Create directories
      run: |
        mkdir -p src/main/java/com/example/bridging/mixin
        mkdir -p src/main/resources
    
    - name: Write BridgingMod.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/example/bridging/BridgingMod.java
        package com.example.bridging;
        import net.fabricmc.api.ClientModInitializer;
        public class BridgingMod implements ClientModInitializer {
            public static final String MOD_ID = "bridging";
            @Override
            public void onInitializeClient() {
                System.out.println("[Simple Bridging] Removes 4-tick placement delay!");
            }
        }
        EOF
    
    - name: Write MinecraftClientMixin.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/example/bridging/mixin/MinecraftClientMixin.java
        package com.example.bridging.mixin;
        import net.minecraft.client.MinecraftClient;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.Shadow;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
        @Mixin(MinecraftClient.class)
        public class MinecraftClientMixin {
            @Shadow
            private int itemUseCooldown;
            
            /**
             * في vanilla Minecraft، لما تضغط Right Click مستمر:
             * - itemUseCooldown بيبدأ بـ 4 ticks
             * - كل tick بينقص واحد
             * - لما يوصل 0، تقدر تحط بلوك تاني
             * 
             * المود ده ببساطة بيخلي الـ cooldown = 0 دايماً
             * عشان تقدر تحط بلوكات بسرعة أكبر لما أنت عايز
             * بس بدون أي تدخل في الـ placement logic نفسه
             */
            @Inject(method = "tick", at = @At("HEAD"))
            private void onTick(CallbackInfo ci) {
                // لو اللاعب بيحاول يحط حاجة
                if (this.itemUseCooldown > 0) {
                    // خلي الـ cooldown = 0 عشان يقدر يحط فوراً
                    this.itemUseCooldown = 0;
                }
            }
        }
        EOF
    
    - name: Write fabric.mod.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/fabric.mod.json
        {
          "schemaVersion": 1,
          "id": "bridging",
          "version": "7.0.0",
          "name": "Zero Delay Bridging",
          "description": "Removes vanilla 4-tick placement delay - YOU control placement",
          "authors": ["SIGMAxox"],
          "license": "MIT",
          "environment": "client",
          "entrypoints": {
            "client": ["com.example.bridging.BridgingMod"]
          },
          "mixins": ["bridging.mixins.json"],
          "depends": {
            "fabricloader": ">=0.11.0",
            "fabric": "*",
            "minecraft": "1.16.5"
          }
        }
        EOF
    
    - name: Write bridging.mixins.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/bridging.mixins.json
        {
          "required": true,
          "minVersion": "0.8",
          "package": "com.example.bridging.mixin",
          "compatibilityLevel": "JAVA_8",
          "client": ["MinecraftClientMixin"],
          "injectors": {"defaultRequire": 1}
        }
        EOF
    
    - name: Write build.gradle
      shell: bash
      run: |
        cat << 'EOF' > build.gradle
        plugins {
            id 'fabric-loom' version '0.7-SNAPSHOT'
            id 'maven-publish'
        }
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
        archivesBaseName = "zero-delay-bridging"
        version = "7.0.0"
        group = "com.example"
        repositories {
            maven { url 'https://maven.fabricmc.net/' }
            maven {
                url 'https://www.cursemaven.com'
                content { includeGroup "curse.maven" }
            }
        }
        dependencies {
            minecraft "com.mojang:minecraft:1.16.5"
            mappings "net.fabricmc:yarn:1.16.5+build.10:v2"
            modImplementation "net.fabricmc:fabric-loader:0.11.3"
            modImplementation "curse.maven:fabric-api-306612:3516413"
        }
        processResources {
            inputs.property "version", project.version
            filesMatching("fabric.mod.json") { expand "version": project.version }
        }
        tasks.withType(JavaCompile).configureEach {
            it.options.encoding = "UTF-8"
        }
        java { withSourcesJar() }
        jar {
            from("LICENSE") { rename { "${it}_${project.archivesBaseName}"} }
        }
        EOF
    
    - name: Write gradle.properties
      run: echo 'org.gradle.jvmargs=-Xmx2G' > gradle.properties
    
    - name: Write settings.gradle
      shell: bash
      run: |
        cat << 'EOF' > settings.gradle
        pluginManagement {
            repositories {
                maven { name = 'Fabric'; url = 'https://maven.fabricmc.net/' }
                gradlePluginPortal()
            }
        }
        rootProject.name = 'zero-delay-bridging'
        EOF
    
    - name: Create Gradle Wrapper
      run: gradle wrapper --gradle-version 6.9
    
    - name: Grant execute permission
      run: chmod +x gradlew
    
    - name: Verify all files
      run: |
        echo "=== Source files ==="
        find src -type f -exec echo {} \; -exec cat {} \;
        echo "=== Config files ==="
        cat build.gradle
        cat settings.gradle
    
    - name: Build mod
      run: ./gradlew clean build --no-daemon --stacktrace
    
    - name: List build output
      run: ls -lah build/libs/
    
    - name: Upload Mod JAR
      uses: actions/upload-artifact@v4
      with:
        name: zero-delay-bridging-v7.0.0-vanilla-placement
        path: build/libs/*.jar
