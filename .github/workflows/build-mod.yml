name: Build Auto Block Placer Mod (Left ALT Toggle) - 1.16.5

on:
  workflow_dispatch:

jobs:
  setup-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 6.9
    
    - name: Clean everything
      run: |
        rm -rf src/ build/ .gradle/ gradle/ *.gradle *.properties gradlew* .gitignore
        find . -name "*.java" -delete
        find . -name "*.json" -delete
    
    - name: Create directories
      run: |
        mkdir -p src/main/java/com/autoplacer/mixin
        mkdir -p src/main/resources
    
    - name: Write AutoBlockPlacerMod.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/autoplacer/AutoBlockPlacerMod.java
        package com.autoplacer;
        
        import net.fabricmc.api.ClientModInitializer;
        
        public class AutoBlockPlacerMod implements ClientModInitializer {
            public static final String MOD_ID = "autoplacer";
            public static boolean isEnabled = false;
            
            @Override
            public void onInitializeClient() {
            }
        }
        EOF
    
    - name: Write MinecraftClientMixin.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/autoplacer/mixin/MinecraftClientMixin.java
        package com.autoplacer.mixin;
        
        import com.autoplacer.AutoBlockPlacerMod;
        import net.minecraft.client.MinecraftClient;
        import net.minecraft.client.network.ClientPlayerEntity;
        import net.minecraft.util.ActionResult;
        import net.minecraft.util.Hand;
        import net.minecraft.util.hit.BlockHitResult;
        import net.minecraft.util.math.BlockPos;
        import net.minecraft.util.math.Direction;
        import net.minecraft.util.math.Vec3d;
        import org.lwjgl.glfw.GLFW;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.Shadow;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
        
        @Mixin(MinecraftClient.class)
        public class MinecraftClientMixin {
            @Shadow
            public ClientPlayerEntity player;
            
            private boolean wasAltPressed = false;
            private int placementCooldown = 0;
            
            @Inject(method = "tick", at = @At("HEAD"))
            private void onClientTick(CallbackInfo ci) {
                if (this.player == null) return;
                
                MinecraftClient client = (MinecraftClient)(Object)this;
                
                // فحص زر Left ALT للتشغيل/الإيقاف
                boolean isAltPressed = GLFW.glfwGetKey(
                    client.getWindow().getHandle(), 
                    GLFW.GLFW_KEY_LEFT_ALT
                ) == GLFW.GLFW_PRESS;
                
                if (isAltPressed && !wasAltPressed) {
                    AutoBlockPlacerMod.isEnabled = !AutoBlockPlacerMod.isEnabled;
                }
                
                wasAltPressed = isAltPressed;
                
                // تقليل الـ cooldown
                if (placementCooldown > 0) {
                    placementCooldown--;
                }
                
                // إذا المود شغال والـ Right Click مضغوط
                if (AutoBlockPlacerMod.isEnabled) {
                    boolean isRightClickPressed = GLFW.glfwGetMouseButton(
                        client.getWindow().getHandle(),
                        GLFW.GLFW_MOUSE_BUTTON_RIGHT
                    ) == GLFW.GLFW_PRESS;
                    
                    if (isRightClickPressed && placementCooldown <= 0) {
                        tryPlaceBlock(client);
                        // سرعة أعلى شوية (2 ticks بدل 4)
                        placementCooldown = 2;
                    }
                }
            }
            
            private void tryPlaceBlock(MinecraftClient client) {
                if (this.player == null) return;
                if (client.interactionManager == null) return;
                if (client.world == null) return;
                
                // تأكد إن اللاعب شايل حاجة في إيده
                if (this.player.getMainHandStack().isEmpty()) return;
                
                // حساب اتجاه الحركة
                Direction moveDirection = getMovementDirection();
                if (moveDirection == null) {
                    return; // لو مش بيتحرك، متحطش حاجة
                }
                
                // البحث عن بلوك للبناء عليه
                BlockPos playerPos = this.player.getBlockPos();
                BlockPos targetBlock = findBlockToPlaceOn(client, playerPos, moveDirection);
                
                if (targetBlock == null) {
                    return; // مفيش بلوك نبني عليه
                }
                
                // تحديد الجانب اللي هنحط عليه والمكان الجديد
                Direction placeDirection = Direction.UP; // نحط على الوش العلوي
                BlockPos newBlockPos = targetBlock.up();
                
                // تأكد إن المكان فاضي
                if (!client.world.getBlockState(newBlockPos).isAir()) {
                    return;
                }
                
                // إنشاء BlockHitResult
                Vec3d hitVec = new Vec3d(
                    targetBlock.getX() + 0.5,
                    targetBlock.getY() + 1.0, // على السطح العلوي
                    targetBlock.getZ() + 0.5
                );
                
                BlockHitResult hitResult = new BlockHitResult(
                    hitVec,
                    placeDirection,
                    targetBlock,
                    false
                );
                
                // محاولة وضع البلوك
                ActionResult result = client.interactionManager.interactBlock(
                    this.player,
                    client.world,
                    Hand.MAIN_HAND,
                    hitResult
                );
                
                // تحريك الإيد (animation)
                if (result.isAccepted()) {
                    this.player.swingHand(Hand.MAIN_HAND);
                }
            }
            
            /**
             * البحث عن بلوك للبناء عليه
             */
            private BlockPos findBlockToPlaceOn(MinecraftClient client, BlockPos playerPos, Direction direction) {
                // البحث في اتجاه الحركة
                BlockPos checkPos = playerPos.offset(direction);
                
                // أولاً: شوف لو فيه بلوك في نفس المستوى
                BlockPos sameLevel = checkPos.down();
                if (!client.world.getBlockState(sameLevel).isAir()) {
                    return sameLevel;
                }
                
                // ثانياً: شوف لو فيه بلوك تحت بمستوى واحد
                BlockPos oneDown = checkPos.down(2);
                if (!client.world.getBlockState(oneDown).isAir()) {
                    return oneDown;
                }
                
                // ثالثاً: شوف لو فيه بلوك تحت بمستويين
                BlockPos twoDown = checkPos.down(3);
                if (!client.world.getBlockState(twoDown).isAir()) {
                    return twoDown;
                }
                
                return null; // مفيش بلوك قريب
            }
            
            /**
             * حساب اتجاه الحركة بناءً على المفاتيح المضغوطة
             */
            private Direction getMovementDirection() {
                if (this.player == null) return null;
                
                MinecraftClient client = (MinecraftClient)(Object)this;
                long window = client.getWindow().getHandle();
                
                // فحص المفاتيح
                boolean forward = GLFW.glfwGetKey(window, GLFW.GLFW_KEY_W) == GLFW.GLFW_PRESS;
                boolean backward = GLFW.glfwGetKey(window, GLFW.GLFW_KEY_S) == GLFW.GLFW_PRESS;
                boolean left = GLFW.glfwGetKey(window, GLFW.GLFW_KEY_A) == GLFW.GLFW_PRESS;
                boolean right = GLFW.glfwGetKey(window, GLFW.GLFW_KEY_D) == GLFW.GLFW_PRESS;
                
                // لو مش بيتحرك
                if (!forward && !backward && !left && !right) {
                    return null;
                }
                
                // حساب اتجاه النظر
                float yaw = this.player.yaw;
                
                // حساب اتجاه الحركة النهائي
                float moveYaw = yaw;
                
                if (forward) {
                    if (left) moveYaw += 45; // أمام-شمال
                    else if (right) moveYaw -= 45; // أمام-يمين
                } else if (backward) {
                    if (left) moveYaw += 135; // خلف-شمال
                    else if (right) moveYaw -= 135; // خلف-يمين
                    else moveYaw += 180; // خلف فقط
                } else if (left) {
                    moveYaw += 90; // شمال فقط
                } else if (right) {
                    moveYaw -= 90; // يمين فقط
                }
                
                return getDirectionFromYaw(moveYaw);
            }
            
            /**
             * تحويل الـ yaw لأحد الاتجاهات الأربعة
             */
            private Direction getDirectionFromYaw(float yaw) {
                yaw = yaw % 360.0f;
                if (yaw < 0) yaw += 360.0f;
                
                if (yaw >= 315.0f || yaw < 45.0f) {
                    return Direction.SOUTH;
                } else if (yaw >= 45.0f && yaw < 135.0f) {
                    return Direction.WEST;
                } else if (yaw >= 135.0f && yaw < 225.0f) {
                    return Direction.NORTH;
                } else {
                    return Direction.EAST;
                }
            }
        }
        EOF
    
    - name: Write fabric.mod.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/fabric.mod.json
        {
          "schemaVersion": 1,
          "id": "autoplacer",
          "version": "1.0.0",
          "name": "Auto Block Placer",
          "description": "Hold Right Click to place blocks automatically. Toggle with Left ALT.",
          "authors": ["SIGMAxox"],
          "license": "MIT",
          "environment": "client",
          "entrypoints": {
            "client": ["com.autoplacer.AutoBlockPlacerMod"]
          },
          "mixins": ["autoplacer.mixins.json"],
          "depends": {
            "fabricloader": ">=0.11.0",
            "minecraft": "1.16.5"
          }
        }
        EOF
    
    - name: Write autoplacer.mixins.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/autoplacer.mixins.json
        {
          "required": true,
          "minVersion": "0.8",
          "package": "com.autoplacer.mixin",
          "compatibilityLevel": "JAVA_8",
          "client": ["MinecraftClientMixin"],
          "injectors": {"defaultRequire": 1}
        }
        EOF
    
    - name: Write build.gradle
      shell: bash
      run: |
        cat << 'EOF' > build.gradle
        plugins {
            id 'fabric-loom' version '0.7-SNAPSHOT'
            id 'maven-publish'
        }
        
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
        
        archivesBaseName = "auto-block-placer"
        version = "1.0.0"
        group = "com.autoplacer"
        
        repositories {
            maven { url 'https://maven.fabricmc.net/' }
        }
        
        dependencies {
            minecraft "com.mojang:minecraft:1.16.5"
            mappings "net.fabricmc:yarn:1.16.5+build.10:v2"
            modImplementation "net.fabricmc:fabric-loader:0.11.3"
        }
        
        processResources {
            inputs.property "version", project.version
            filesMatching("fabric.mod.json") {
                expand "version": project.version
            }
        }
        
        tasks.withType(JavaCompile).configureEach {
            it.options.encoding = "UTF-8"
        }
        
        java {
            withSourcesJar()
        }
        
        jar {
            from("LICENSE") {
                rename { "${it}_${project.archivesBaseName}"}
            }
        }
        EOF
    
    - name: Write gradle.properties
      run: echo 'org.gradle.jvmargs=-Xmx2G' > gradle.properties
    
    - name: Write settings.gradle
      shell: bash
      run: |
        cat << 'EOF' > settings.gradle
        pluginManagement {
            repositories {
                maven {
                    name = 'Fabric'
                    url = 'https://maven.fabricmc.net/'
                }
                gradlePluginPortal()
            }
        }
        rootProject.name = 'auto-block-placer'
        EOF
    
    - name: Create Gradle Wrapper
      run: gradle wrapper --gradle-version 6.9
    
    - name: Grant execute permission
      run: chmod +x gradlew
    
    - name: Verify all files
      run: |
        echo "=== Source files ==="
        find src -type f -exec echo {} \; -exec cat {} \;
        echo ""
        echo "=== Config files ==="
        cat build.gradle
        echo ""
        cat settings.gradle
    
    - name: Build mod
      run: ./gradlew clean build --no-daemon --stacktrace
    
    - name: List build output
      run: ls -lah build/libs/
    
    - name: Upload Mod JAR
      uses: actions/upload-artifact@v4
      with:
        name: auto-block-placer-v1.0.0
        path: build/libs/*.jar
