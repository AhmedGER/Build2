# ملف: .github/workflows/build.yml
name: Build SigmaStealth Mod

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout empty repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
      
      - name: Create ENTIRE Mod from Scratch
        run: |
          # إنشاء كل الملفات من الصفر في ريبو فارغ
          mkdir -p src/main/java/com/sigmaxox/sigmasteralth
          mkdir -p src/main/resources/assets/sigmasteralth
          
          # 1. إنشاء fabric.mod.json
          cat > src/main/resources/fabric.mod.json << 'EOF'
          {
            "schemaVersion": 1,
            "id": "sigmasteralth",
            "version": "1.0.0",
            "name": "SigmaStealth",
            "description": "Client-side stealth mod by SIGMAxox",
            "authors": ["SIGMAxox"],
            "contact": {},
            "license": "MIT",
            "icon": "assets/sigmasteralth/icon.png",
            "environment": "client",
            "entrypoints": {
              "client": [
                "com.sigmaxox.sigmasteralth.SigmaStealthMod"
              ]
            },
            "depends": {
              "fabricloader": ">=0.11.3",
              "fabric": "*",
              "minecraft": "1.16.5",
              "java": ">=8"
            }
          }
          EOF
          
          # 2. إنشاء الملف الرئيسي
          cat > src/main/java/com/sigmaxox/sigmasteralth/SigmaStealthMod.java << 'EOF'
          package com.sigmaxox.sigmasteralth;
          
          import net.fabricmc.api.ClientModInitializer;
          import net.fabricmc.fabric.api.client.event.lifecycle.v1.ClientTickEvents;
          import net.fabricmc.fabric.api.client.keybinding.v1.KeyBindingHelper;
          import net.minecraft.client.MinecraftClient;
          import net.minecraft.client.option.KeyBinding;
          import net.minecraft.client.util.InputUtil;
          import net.minecraft.text.Text;
          import org.lwjgl.glfw.GLFW;
          
          public class SigmaStealthMod implements ClientModInitializer {
              private static KeyBinding stealthKey;
              public static boolean stealthEnabled = false;
              
              @Override
              public void onInitializeClient() {
                  // تسجيل مفتاح ALT
                  stealthKey = KeyBindingHelper.registerKeyBinding(new KeyBinding(
                      "key.sigmasteralth.stealth",
                      InputUtil.Type.KEYSYM,
                      GLFW.GLFW_KEY_LEFT_ALT,
                      "category.sigmasteralth.general"
                  ));
                  
                  // التحقق من الضغط على المفتاح
                  ClientTickEvents.END_CLIENT_TICK.register(client -> {
                      if (stealthKey.wasPressed()) {
                          stealthEnabled = !stealthEnabled;
                          
                          if (client.player != null) {
                              if (stealthEnabled) {
                                  client.player.sendMessage(Text.of("§6SigmaStealth §a- ON"), true);
                                  NetworkHandler.startStealth(client.player.getPos());
                              } else {
                                  client.player.sendMessage(Text.of("§6SigmaStealth §c- OFF"), true);
                                  NetworkHandler.stopStealth();
                              }
                          }
                      }
                      
                      // إرسال الحزم الوهمية
                      if (stealthEnabled) {
                          NetworkHandler.sendFakePackets();
                      }
                  });
              }
          }
          EOF
          
          # 3. إنشاء NetworkHandler
          cat > src/main/java/com/sigmaxox/sigmasteralth/NetworkHandler.java << 'EOF'
          package com.sigmaxox.sigmasteralth;
          
          import net.minecraft.client.MinecraftClient;
          import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket;
          import net.minecraft.util.math.Vec3d;
          
          public class NetworkHandler {
              private static Vec3d fakePosition;
              private static boolean isStealthActive = false;
              
              public static void startStealth(Vec3d pos) {
                  fakePosition = pos;
                  isStealthActive = true;
              }
              
              public static void stopStealth() {
                  isStealthActive = false;
                  fakePosition = null;
              }
              
              public static void sendFakePackets() {
                  if (!isStealthActive || fakePosition == null) return;
                  
                  MinecraftClient client = MinecraftClient.getInstance();
                  if (client.getNetworkHandler() == null || client.player == null) return;
                  
                  // إرسال موقع وهمي للخادم
                  client.getNetworkHandler().sendPacket(new PlayerMoveC2SPacket.PositionAndOnGround(
                      fakePosition.x, fakePosition.y, fakePosition.z, client.player.isOnGround()
                  ));
              }
          }
          EOF
          
          # 4. إنشاء build.gradle
          cat > build.gradle << 'EOF'
          plugins {
              id 'fabric-loom' version '0.6-SNAPSHOT'
          }
          
          version = "1.0.0"
          group = "com.sigmaxox"
          
          dependencies {
              minecraft "com.mojang:minecraft:1.16.5"
              mappings "net.fabricmc:yarn:1.16.5+build.10:v2"
              modImplementation "net.fabricmc:fabric-loader:0.11.6"
              modImplementation "net.fabricmc.fabric-api:fabric-api:0.42.0+1.16.5"
          }
          
          processResources {
              inputs.property "version", project.version
              filesMatching("fabric.mod.json") {
                  expand "version": project.version
              }
          }
          EOF
          
          # 5. إنشاء settings.gradle
          cat > settings.gradle << 'EOF'
          pluginManagement {
              repositories {
                  maven { url = "https://maven.fabricmc.net/" }
                  gradlePluginPortal()
              }
          }
          rootProject.name = "sigmasteralth"
          EOF
          
          # 6. إنشاء gradle.properties
          cat > gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx2G
          EOF
      
      - name: Build Mod
        run: |
          # تحميل وتثبيت Gradle يدوياً
          wget https://services.gradle.org/distributions/gradle-7.5-bin.zip
          unzip gradle-7.5-bin.zip
          export PATH=$PWD/gradle-7.5/bin:$PATH
          
          # البناء
          gradle build --no-daemon --stacktrace
      
      - name: Upload MOD File
        uses: actions/upload-artifact@v4
        with:
          name: SigmaStealth-MOD
          path: build/libs/*.jar
