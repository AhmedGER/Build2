# .github/workflows/build-mod.yml
name: Build Combat Mod

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 6.9
    
    - name: Create project structure
      run: mkdir -p src/main/{java/com/example/combat/mixin,resources}
    
    - name: Create CombatMod.java
      run: |
        cat > src/main/java/com/example/combat/CombatMod.java << 'END'
        package com.example.combat;
        import net.fabricmc.api.ClientModInitializer;
        public class CombatMod implements ClientModInitializer {
            public static final String MOD_ID = "combat";
            public static boolean enabled = false;
            public static int attackDelay = 0;
            @Override
            public void onInitializeClient() {
                System.out.println("[Combat Mod] Loaded! Press R to toggle");
            }
        }
        END
    
    - name: Create ClientPlayerEntityMixin.java
      run: |
        cat > src/main/java/com/example/combat/mixin/ClientPlayerEntityMixin.java << 'END'
        package com.example.combat.mixin;
        import com.example.combat.CombatMod;
        import net.minecraft.client.MinecraftClient;
        import net.minecraft.client.network.ClientPlayerEntity;
        import net.minecraft.entity.Entity;
        import net.minecraft.entity.LivingEntity;
        import net.minecraft.util.Hand;
        import net.minecraft.util.math.Vec3d;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
        import java.util.List;
        @Mixin(ClientPlayerEntity.class)
        public class ClientPlayerEntityMixin {
            @Inject(method = "tick", at = @At("HEAD"))
            private void onTick(CallbackInfo ci) {
                ClientPlayerEntity player = (ClientPlayerEntity)(Object)this;
                MinecraftClient client = MinecraftClient.getInstance();
                if (client.world == null || client.options == null) return;
                if (client.options.keyDrop.wasPressed()) {
                    CombatMod.enabled = !CombatMod.enabled;
                    player.sendMessage(net.minecraft.text.Text.of("Combat: " + (CombatMod.enabled ? "ON" : "OFF")), true);
                }
                if (!CombatMod.enabled) return;
                if (CombatMod.attackDelay > 0) {
                    CombatMod.attackDelay--;
                    return;
                }
                Entity target = null;
                double closestDist = 4.5;
                List<Entity> entities = client.world.getEntities();
                for (Entity e : entities) {
                    if (!(e instanceof LivingEntity)) continue;
                    if (e == player) continue;
                    if (e.isSpectator()) continue;
                    LivingEntity le = (LivingEntity)e;
                    if (le.getHealth() <= 0) continue;
                    double dist = player.distanceTo(e);
                    if (dist < closestDist) {
                        closestDist = dist;
                        target = e;
                    }
                }
                if (target != null) {
                    Vec3d targetPos = target.getPos().add(0, target.getHeight() * 0.5, 0);
                    Vec3d playerPos = player.getPos().add(0, player.getStandingEyeHeight(), 0);
                    Vec3d direction = targetPos.subtract(playerPos).normalize();
                    double yaw = Math.toDegrees(Math.atan2(direction.z, direction.x)) - 90;
                    double pitch = -Math.toDegrees(Math.asin(direction.y));
                    player.yaw = (float)yaw;
                    player.pitch = (float)pitch;
                    if (client.interactionManager != null) {
                        client.interactionManager.attackEntity(player, target);
                        player.swingHand(Hand.MAIN_HAND);
                        CombatMod.attackDelay = 2;
                    }
                }
            }
        }
        END
    
    - name: Create fabric.mod.json
      run: |
        cat > src/main/resources/fabric.mod.json << 'END'
        {
          "schemaVersion": 1,
          "id": "combat",
          "version": "1.0.0",
          "name": "Combat Mod",
          "description": "Auto aim and attack - Press R to toggle",
          "authors": ["AutoBuilder"],
          "license": "MIT",
          "environment": "client",
          "entrypoints": {
            "client": ["com.example.combat.CombatMod"]
          },
          "mixins": ["combat.mixins.json"],
          "depends": {
            "fabricloader": ">=0.11.0",
            "fabric": "*",
            "minecraft": "1.16.5"
          }
        }
        END
    
    - name: Create combat.mixins.json
      run: |
        cat > src/main/resources/combat.mixins.json << 'END'
        {
          "required": true,
          "minVersion": "0.8",
          "package": "com.example.combat.mixin",
          "compatibilityLevel": "JAVA_8",
          "client": ["ClientPlayerEntityMixin"],
          "injectors": {"defaultRequire": 1}
        }
        END
    
    - name: Create build.gradle
      run: |
        cat > build.gradle << 'END'
        plugins {
            id 'fabric-loom' version '0.7-SNAPSHOT'
            id 'maven-publish'
        }
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
        archivesBaseName = "combat-mod"
        version = "1.0.1"
        group = "com.example"
        repositories {
            maven { url 'https://maven.fabricmc.net/' }
            maven {
                url 'https://www.cursemaven.com'
                content { includeGroup "curse.maven" }
            }
        }
        dependencies {
            minecraft "com.mojang:minecraft:1.16.5"
            mappings "net.fabricmc:yarn:1.16.5+build.10:v2"
            modImplementation "net.fabricmc:fabric-loader:0.11.3"
            modImplementation "curse.maven:fabric-api-306612:3516413"
        }
        processResources {
            inputs.property "version", project.version
            filesMatching("fabric.mod.json") { expand "version": project.version }
        }
        tasks.withType(JavaCompile).configureEach {
            it.options.encoding = "UTF-8"
        }
        java { withSourcesJar() }
        END
    
    - name: Create gradle.properties
      run: echo 'org.gradle.jvmargs=-Xmx2G' > gradle.properties
    
    - name: Create settings.gradle
      run: |
        cat > settings.gradle << 'END'
        pluginManagement {
            repositories {
                maven { name = 'Fabric'; url = 'https://maven.fabricmc.net/' }
                gradlePluginPortal()
            }
        }
        rootProject.name = 'combat-mod'
        END
    
    - name: Create Gradle Wrapper
      run: gradle wrapper --gradle-version 6.9
    
    - name: Grant execute permission
      run: chmod +x gradlew
    
    - name: Build mod
      run: ./gradlew clean build --no-daemon
    
    - name: Upload Mod JAR
      uses: actions/upload-artifact@v4
      with:
        name: combat-mod-killaura-v1.0.1-FIXED
        path: build/libs/*.jar
